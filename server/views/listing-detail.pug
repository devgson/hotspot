extends layout

block prepend stylesheets
  script(async src="https://www.googletagmanager.com/gtag/js?id=UA-130675440-1")
  script(src='/js/gtag.js')

block content
  include partials/navbar.pug
  main
    .hero_in.shop_detail
      .wrapper
        span.magnific-gallery
          a.btn_photos(href='', title='Photo title', data-effect='mfp-zoom-in') View photos
          if listing.images && listing.images.length > 0
            each image in listing.images
              a(href=image.secure_url, title='Photo title', data-effect='mfp-zoom-in')
    // /hero_in
    nav.secondary_nav.sticky_horizontal_2
      .container
        ul.clearfix.d-flex.align-items-baseline.justify-content-start
          li
            a.active(href='#description') Description
          li
            a(href='#reviews') Reviews
          if currentUser
            - const changeIdToString = currentUser.bookmarks.map( _id => _id.toString() );
            - const userBookmarked = changeIdToString.includes( listing._id.toString() );
            - const formClass = userBookmarked ? 'btn_bookmark_selected' : '';
            li.bookmark.d-block.float-right(class=(formClass) name="bookmarks" style="margin-left:auto")
              form(action=`/api/bookmark/${listing._id}` method="POST")
                a.icon-bookmark-2()
                button(type="submit" style="cursor:pointer; color: white;background: transparent; border: 0px;") #{userBookmarked ? "Bookmarked" : 'Bookmark'}

          li.d-block.float-right(class=(formClass) name="verify" style="margin-left:auto")
              form(action=`/verify` method="POST")
                a.icon-bookmark-2()
                input(type="text" value=`${listing}` name="listing" hidden)
                button(type="submit" style="cursor:pointer; color: white;background: transparent; border: 0px;") Claim Listing
    .container.margin_60_35
      .row
        .col-lg-8
          section#description
            .detail_title_1
              h1= listing.title
              a.address(href='https://www.google.com/maps/dir//Assistance+–+Hôpitaux+De+Paris,+3+Avenue+Victoria,+75004+Paris,+Francia/@48.8606548,2.3348734,14z/data=!4m15!1m6!3m5!1s0x47e66e1de36f4147:0xb6615b4092e0351f!2sAssistance+Publique+-+Hôpitaux+de+Paris+(AP-HP)+-+Siège!8m2!3d48.8568376!4d2.3504305!4m7!1m0!1m5!1m1!1s0x47e67031f8c20147:0xa6a9af76b1e2d899!2m2!1d2.3504327!2d48.8568361')= listing.info.address
            p= listing.description
            h5.add_bottom_15 Tags
            .row.add_bottom_30
              .col-md-12
                ul.bullets
                  each tag in listing.tags                 
                    li.ml-1.list-inline-item= tag
            // /row
            .opening
              .ribbon
                span.open Now Open
              .test
                h3.icon_clock_alt.mr-2.d-inline-block
                h4.d-inline-block Opening Hours
              .row
              if listing.hours
                - var hours3 = Object.entries( listing.hours ).slice(0 ,4);
                - var hours4 = Object.entries( listing.hours ).slice(4);
                .col-md-6
                  each hour in hours3
                    ul
                      li
                        | #{hour[0].toUpperCase()}
                        if ( hour[1][0].includes('Open') || hour[1][1].includes('Clos') )
                          span Closed
                        else  
                          span #{hour[1][0]} - #{hour[1][1]}
                .col-md-6
                  each hour in hours4
                    ul
                      li
                        | #{hour[0].toUpperCase()}
                        if ( hour[1][0].includes('Open') || hour[1][1].includes('Clos') )
                          span Closed
                        else  
                          span #{hour[1][0]} - #{hour[1][1]}
            hr
            h3 Location
            #map.map.map_single.add_bottom_45
              img(style="width : 100%" src=`https://maps.googleapis.com/maps/api/staticmap?center=${listing.info.address}&zoom=16&maptype=roadmap&format=png&size=900x400&key=${process.env.GOOGLE_KEY}&markers=${listing.info.address}&scale=1`)
            // End Map
            // /section
            section#reviews
              hr
              h2 Reviews
              .reviews-container.add_bottom_30
                .row
                  .col-lg-3
                    #review_summary
                      if reviewsInfo
                        strong #{(reviewsInfo.total/reviewsInfo.numberOfReviews).toFixed(1)*2} / 10
                        //em Superb
                        small Based on #{reviewsInfo.numberOfReviews} reviews
                      else 
                        strong 0 / 10
                  .col-lg-9
                    .row
                      .col-lg-10.col-9
                        .progress
                          .progress-bar(role='progressbar', style=`width: ${reviewsStat[5]}%`, aria-valuenow='90', aria-valuemin='0', aria-valuemax='100')
                            | #{numberOfReviewsPerRating[5]}
                      .col-lg-2.col-3
                        small
                          strong 5 stars
                    // /row
                    .row
                      .col-lg-10.col-9
                        .progress
                          .progress-bar(role='progressbar', style=`width: ${reviewsStat[4]}%`, aria-valuenow='95', aria-valuemin='0', aria-valuemax='100')
                            | #{numberOfReviewsPerRating[4]}
                      .col-lg-2.col-3
                        small
                          strong 4 stars
                    // /row
                    .row
                      .col-lg-10.col-9
                        .progress
                          .progress-bar(role='progressbar', style=`width: ${reviewsStat[3]}%`, aria-valuenow='60', aria-valuemin='0', aria-valuemax='100')
                            | #{numberOfReviewsPerRating[3]}
                      .col-lg-2.col-3
                        small
                          strong 3 stars
                    // /row
                    .row
                      .col-lg-10.col-9
                        .progress
                          .progress-bar(role='progressbar', style=`width: ${reviewsStat[2]}%`, aria-valuenow='20', aria-valuemin='0', aria-valuemax='100')
                            | #{numberOfReviewsPerRating[2]}
                      .col-lg-2.col-3
                        small
                          strong 2 stars
                    // /row
                    .row
                      .col-lg-10.col-9
                        .progress
                          .progress-bar(role='progressbar', style=`width: ${reviewsStat[1]}%`, aria-valuenow='0', aria-valuemin='0', aria-valuemax='100')
                            | #{numberOfReviewsPerRating[1]}
                      .col-lg-2.col-3
                        small
                          strong 1 stars
                    // /row
                    // /row
                each review in listing.reviews
                  .reviews-container
                    .review-box.clearfix
                      figure.rev-thumb
                        img(src='img/avatar3.jpg', alt='')
                      .rev-content
                        .rev-text
                          h3 #{review.user.first_name}
                        .rating
                          - const rating = review.rating;
                          - const noStars = 5 - rating;
                          - for( var i =0 ; i < rating; i++){
                              i.icon-star.voted
                          - }
                          - for( var j=0; j < noStars; j++){
                              i.icon-star
                          - }
                        .rev-info
                          | #{moment(review.createdAt).format('MMMM, Do YYYY')}:
                        if review.user && currentUser
                          if review.user._id.toString() === currentUser._id.toString()
                            a.rev-text.float-right(onclick='return confirm(\'Are you sure?\')' href=(`/review/delete/${review._id}`) style='color:#dc3545; cursor:pointer')
                              span.icon_trash
                              small.ml-1 Delete
                        .rev-text
                          p
                            | #{review.content}
                        
                // /review-box
                // /review-container
                // /section
                hr
                if !currentUser
                  .box_detail.booking
                    .price
                      h5.d-inline Rate and Write Reviews
                    h3
                      p(style="font-weight:lighter") You need to log in to write reviews
                    a#submit-contact-detail.add_top_30.btn_1.half-width.purchase(href="/register")
                      | Log In
                else
                  .add-review
                    h5 Leave a Review
                    form(method="POST" action=`/review/${listing._id}`)
                      .row
                        //input(type="hidden" value=(listing._id) name="id")
                        .form-group.col-md-6
                          label Rating 
                          .custom-select-form
                            select#rating_review.wide(name='rating')
                              option(value='1' selected) 1 (Lowest)
                              option(value='2') 2
                              option(value='3') 3
                              option(value='4') 4
                              option(value='5') 5 (Highest)
                        .form-group.col-md-12
                          label Your Review
                          textarea#review_text.form-control(name='content', style='height:130px;')
                        .form-group.col-md-12.add_top_20.add_bottom_30
                          input#submit-review.btn_1(type='submit', value='Submit')
        // /col
        aside#sidebar.col-lg-4
          .box_detail.booking
            .price
              h5.d-inline Contact us
              if reviewsInfo
                .score
                  span
                    | Good
                    em #{reviewsInfo.numberOfReviews} Reviews
                  strong #{(reviewsInfo.total/reviewsInfo.numberOfReviews).toFixed(1)*2}
              else
                .score
                  span
                    em 0 Reviews
                  strong 0.0
            #message-contact-detail
            form#contact_detail(method='post', action='', autocomplete='off')
              .form-group
                input#name_detail.form-control(type='text', placeholder='Name', name='name' required)
                i.ti-user
              .form-group
                input#email_detail.form-control(type='email', placeholder='Email', name='email' required)
                i.icon_mail_alt
              .form-group
                textarea#message_detail.form-control(placeholder='Your message', name='message' required)
                i.ti-pencil
              .form-group
                input#submit-contact-detail.add_top_30.btn_1.full-width.purchase(type='submit', value='Contact us')
              
          ul.share-buttons
            if listing.social_media.facebook
              li
                a.fb-share(href=(listing.social_media.facebook) target="blank")
                  i.social_facebook
                  |  Share
            if listing.social_media.twitter
              li
                a.twitter-share(href=(listing.social_media.twitter) target="blank")
                  i.social_twitter
                  |  Tweet
      // /row
      // /container
  include partials/footer.pug
block append scripts
  script(src='/js/analytics.js')
